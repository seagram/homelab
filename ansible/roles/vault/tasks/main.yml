---
- name: Get Tailscale IP address
  ansible.builtin.shell: tailscale ip -4
  register: tailscale_ip
  changed_when: false

- name: Configure Vault with S3 backend
  ansible.builtin.copy:
    content: |
      storage "s3" {
        bucket = "{{ vault_s3_bucket }}"
        region = "{{ vault_s3_region }}"
      }

      listener "tcp" {
        address     = "0.0.0.0:8200"
        tls_disable = 1
      }

      api_addr = "http://{{ tailscale_ip.stdout }}:8200"
      ui = true
    dest: /etc/vault.d/vault.hcl
    owner: vault
    group: vault
    mode: "0640"
  notify: restart vault

- name: Enable and start Vault service
  ansible.builtin.systemd:
    name: vault
    enabled: yes
    state: started

- name: Wait for Vault to be ready
  ansible.builtin.wait_for:
    port: 8200
    delay: 2
    timeout: 30

- name: Check if Vault is already initialized
  ansible.builtin.uri:
    url: http://localhost:8200/v1/sys/init
    method: GET
  register: vault_init_status

- name: Initialize Vault
  ansible.builtin.uri:
    url: http://localhost:8200/v1/sys/init
    method: POST
    body_format: json
    body:
      secret_shares: "{{ vault_secret_shares }}"
      secret_threshold: "{{ vault_secret_threshold }}"
  register: vault_init_result
  when: not vault_init_status.json.initialized

- name: Save Vault init output locally
  ansible.builtin.copy:
    content: "{{ vault_init_result.json | to_nice_json }}"
    dest: /tmp/vault-init-keys.json
    mode: "0600"
  when: not vault_init_status.json.initialized

- name: Upload Vault keys to S3
  amazon.aws.s3_object:
    bucket: "{{ vault_s3_bucket }}"
    object: vault-init-keys.json
    src: /tmp/vault-init-keys.json
    mode: put
    encrypt: true
  when: not vault_init_status.json.initialized

- name: Remove local keys file
  ansible.builtin.file:
    path: /tmp/vault-init-keys.json
    state: absent
  when: not vault_init_status.json.initialized

- name: Display initialization message
  ansible.builtin.debug:
    msg: "Vault initialized. Keys saved to s3://{{ vault_s3_bucket }}/vault-init-keys.json with encryption. SAVE THESE SECURELY!"
  when: not vault_init_status.json.initialized

- name: Display already initialized message
  ansible.builtin.debug:
    msg: "Vault is already initialized"
  when: vault_init_status.json.initialized
