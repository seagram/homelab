---
- name: Download GPG key
  ansible.builtin.uri:
    dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
    url: https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg

- name: Add package signing repository
  ansible.builtin.uri:
    dest: /etc/apt/sources.list.d/tailscale.list
    url: https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list

- name: Install tailscale package
  ansible.builtin.apt:
    name: tailscale
    update_cache: true
    state: present

- name: Check if tailscale is already connected
  ansible.builtin.command: tailscale status
  register: tailscale_status
  failed_when: false
  changed_when: false

- name: Connect to tailscale
  ansible.builtin.command: tailscale up --authkey={{ tailscale_auth_key }} --ssh
  when: "'not logged in' in tailscale_status.stderr or tailscale_status.rc != 0"

- name: Install UFW
  ansible.builtin.apt:
    name: ufw
    state: present

- name: Reset UFW to defaults
  community.general.ufw:
    state: reset

- name: Allow SSH access only through Tailscale
  community.general.ufw:
    rule: allow
    interface: tailscale0
    port: "22"
    proto: tcp
    direction: in

- name: Deny SSH access from all other interfaces
  community.general.ufw:
    rule: deny
    port: "22"
    proto: tcp

- name: Enable UFW
  community.general.ufw:
    state: enabled

- name: Disable SSH password authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PasswordAuthentication="
    line: "PasswordAuthentication=no"
    backup: yes

- name: Restart SSH service
  ansible.builtin.systemd:
    name: ssh
    state: restarted
