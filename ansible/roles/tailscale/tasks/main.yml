---
- name: Download GPG key
  become: true
  ansible.builtin.uri:
    dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
    url: https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg

- name: Add package signing repository
  become: true
  ansible.builtin.uri:
    dest: /etc/apt/sources.list.d/tailscale.list
    url: https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list

- name: Install tailscale package
  become: true
  ansible.builtin.apt:
    name: tailscale
    update_cache: true
    state: present

- name: Check if tailscale is already connected
  ansible.builtin.command: tailscale status
  register: tailscale_status
  failed_when: false
  changed_when: false

- name: Connect to tailscale
  become: true
  ansible.builtin.command: tailscale up --authkey={{ tailscale_auth_key }} --ssh
  when: "'not logged in' in tailscale_status.stderr or tailscale_status.rc != 0"

- name: Restart SSH service
  become: true
  ansible.builtin.systemd:
    name: ssh
    state: restarted
